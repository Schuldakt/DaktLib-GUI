# =============================================================================
# DaktLib-GUI â€” Release Workflow
# =============================================================================

name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: true
        type: string

env:
  CMAKE_VERSION: "4.2.1"
  BUILD_TYPE: Release

jobs:
  build-all:
    name: Build ${{ matrix.rid }}
    runs-on: ${{ matrix.runner }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - rid: win-x64
            os: windows
            runner: windows-latest
            cmake_arch: x64
          - rid: win-x86
            os: windows
            runner: windows-latest
            cmake_arch: Win32
          - rid: linux-x64
            os: linux
            runner: ubuntu-24.04
          - rid: osx-x64
            os: macos
            runner: macos-13
          - rid: osx-arm64
            os: macos
            runner: macos-14

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - uses: lukka/get-cmake@latest
        with:
          cmakeVersion: ${{ env.CMAKE_VERSION }}
          
      - name: Setup MSVC
        if: matrix.os == 'windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.cmake_arch == 'Win32' && 'x86' || 'x64' }}
          
      - name: Install Dependencies (Linux)
        if: matrix.os == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build libvulkan-dev
          
      - name: Install Dependencies (macOS)
        if: matrix.os == 'macos'
        run: brew install ninja
        
      - name: Setup Vulkan SDK
        if: matrix.os != 'macos'
        uses: humbletim/setup-vulkan-sdk@v1.2.0
        with:
          vulkan-query-version: 1.3.290.0
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-use-cache: true
          
      - name: Configure (Windows)
        if: matrix.os == 'windows'
        run: |
          cmake -S . -B build `
            -G "Visual Studio 17 2022" `
            -A ${{ matrix.cmake_arch }} `
            -DDAKT_GUI_BUILD_SHARED=ON `
            -DDAKT_GUI_BUILD_STATIC=ON
            
      - name: Configure (Unix)
        if: matrix.os != 'windows'
        run: |
          cmake -S . -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DDAKT_GUI_BUILD_SHARED=ON \
            -DDAKT_GUI_BUILD_STATIC=ON
            
      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel
        
      - name: Install
        run: cmake --install build --config ${{ env.BUILD_TYPE }} --prefix staging/${{ matrix.rid }}
        
      - name: Upload Staging
        uses: actions/upload-artifact@v4
        with:
          name: staging-${{ matrix.rid }}
          path: staging/${{ matrix.rid }}/

  package-nuget:
    name: Package NuGet
    needs: build-all
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          pattern: staging-*
          
      - name: Prepare NuGet Structure
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          
          mkdir -p nuget/runtimes/{win-x64,win-x86,linux-x64,osx-x64,osx-arm64}/native
          mkdir -p nuget/build
          
          # Copy native libraries
          cp -r artifacts/staging-win-x64/lib/* nuget/runtimes/win-x64/native/ || true
          cp -r artifacts/staging-win-x86/lib/* nuget/runtimes/win-x86/native/ || true
          cp -r artifacts/staging-linux-x64/lib/* nuget/runtimes/linux-x64/native/ || true
          cp -r artifacts/staging-osx-x64/lib/* nuget/runtimes/osx-x64/native/ || true
          cp -r artifacts/staging-osx-arm64/lib/* nuget/runtimes/osx-arm64/native/ || true
          
          # Copy headers (from any platform, they're the same)
          cp -r artifacts/staging-linux-x64/include nuget/ || cp -r artifacts/staging-win-x64/include nuget/
          
          # Generate .nuspec with correct version
          sed "s/\$VERSION\$/${VERSION}/g" DaktLib.GUI.nuspec > nuget/DaktLib.GUI.nuspec
          
      - name: Pack NuGet
        run: |
          cd nuget
          nuget pack DaktLib.GUI.nuspec
          
      - name: Upload NuGet Package
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: nuget/*.nupkg

  create-release:
    name: Create GitHub Release
    needs: [build-all, package-nuget]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - uses: actions/checkout@v4
      
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          
      - name: Create Archives
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          VERSION="${VERSION#v}"
          
          cd artifacts
          for dir in staging-*/; do
            rid=$(basename "$dir" | sed 's/staging-//')
            tar -czvf "daktlib-gui-${VERSION}-${rid}.tar.gz" -C "$dir" .
          done
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: DaktLib-GUI v${{ github.event.inputs.version || github.ref_name }}
          draft: true
          generate_release_notes: true
          files: |
            artifacts/*.tar.gz
            artifacts/nuget-package/*.nupkg