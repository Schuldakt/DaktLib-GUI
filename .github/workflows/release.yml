name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CMAKE_VERSION: 4.21
  NINJA_VERSION: 1.11
  BUILD_TYPE: Release

jobs:
  build-all-platforms:
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Windows x86
            runner-labels: "self-hosted,windows,x86"
            arch: win-x86
            toolchain: toolchains/windows-x86.cmake
            artifact-prefix: ""
            lib-ext: ".lib"

          - name: Windows x64
            runner-labels: "self-hosted,windows,x64"
            arch: win-x64
            toolchain: toolchains/windows-x64.cmake
            artifact-prefix: ""
            lib-ext: ".lib"

          - name: Linux x64
            runner-labels: "self-hosted,linux,x64"
            arch: linux-x64
            toolchain: toolchains/linux-x64.cmake
            artifact-prefix: "lib"
            lib-ext: ".a"

          - name: macOS x64
            runner-labels: "self-hosted,macos,x64"
            arch: osx-x64
            toolchain: toolchains/macos-x64.cmake
            artifact-prefix: "lib"
            lib-ext: ".a"

          - name: macOS ARM64
            runner-labels: "self-hosted,macos,arm64"
            arch: osx-arm64
            toolchain: toolchains/macos-arm64.cmake
            artifact-prefix: "lib"
            lib-ext: ".a"

    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.runner-labels }}

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt update
          sudo apt install -y cmake ninja-build clang vulkan-sdk

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja vulkan-sdk

      - name: Configure CMake
        run: |
          cmake -S . -B build -G "Ninja" \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_TOOLCHAIN_FILE=${{ matrix.toolchain }} \
            -DDAKT_GUI_BUILD_TESTS=ON \
            -DDAKT_GUI_BUILD_SHOWCASE=ON

      - name: Build
        run: ninja -C build

      - name: Run tests
        run: ctest --output-on-failure -C ${{ env.BUILD_TYPE }}
        working-directory: build

      - name: Create artifact directory
        run: |
          mkdir -p release-artifacts/${{ matrix.arch }}/lib
          mkdir -p release-artifacts/${{ matrix.arch }}/include

      - name: Gather artifacts
        shell: bash
        run: |
          cp build/lib/${{ matrix.artifact-prefix }}DaktLib-GUI* \
             release-artifacts/${{ matrix.arch }}/lib/ || true
          cp -r include/dakt \
             release-artifacts/${{ matrix.arch }}/include/ || true
          cp -r bindings/csharp/*.cs \
             release-artifacts/${{ matrix.arch }}/ || true

      - name: Upload release artifacts
        uses: actions/upload-artifact@v3
        with:
          name: release-${{ matrix.arch }}
          path: release-artifacts/

  create-nuget:
    needs: build-all-platforms
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      - name: Organize artifacts for NuGet
        shell: bash
        run: |
          mkdir -p nuget-staging/{native,lib/net8.0}
          
          # Copy natives per RID
          for rid in win-x86 win-x64 linux-x64 osx-x64 osx-arm64; do
            mkdir -p nuget-staging/native/$rid/{lib,include}
            cp -r artifacts/release-$rid/$rid/lib/* nuget-staging/native/$rid/lib/ || true
            cp -r artifacts/release-$rid/$rid/include/* nuget-staging/native/$rid/include/ || true
          done
          
          # Copy C# bindings
          cp artifacts/release-win-x64/win-x64/*.dll nuget-staging/lib/net8.0/ || true
          cp artifacts/release-win-x64/win-x64/*.cs nuget-staging/lib/net8.0/ || true

      - name: Create NuGet package
        run: |
          # Install nuget CLI
          dotnet tool install -g nuget.commandline
          
          # Get version from tag
          VERSION=${GITHUB_REF#refs/tags/v}
          
          # Update nuspec with version
          sed -i "s/<version>0.1.0<\/version>/<version>$VERSION<\/version>/" DaktLib.GUI.nuspec
          
          # Pack
          nuget pack DaktLib.GUI.nuspec -OutputDirectory ./nuget-package

      - name: Upload NuGet package
        uses: actions/upload-artifact@v3
        with:
          name: nuget-package
          path: nuget-package/*.nupkg

      - name: Publish to NuGet
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          nuget push nuget-package/DaktLib.GUI.$VERSION.nupkg \
            -ApiKey ${{ secrets.NUGET_API_KEY }} \
            -Source https://api.nuget.org/v3/index.json

  create-release:
    needs: create-nuget
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          path: release-artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-artifacts/**/*.nupkg
            release-artifacts/**/*.lib
            release-artifacts/**/*.a
            release-artifacts/**/*.dll
            release-artifacts/**/*.so
            release-artifacts/**/*.dylib
          body: |
            # DaktLib-GUI Release ${{ github.ref }}
            
            Cross-platform immediate-first GUI library with Vulkan rendering.
            
            **Platforms:**
            - Windows x86/x64
            - Linux x64
            - macOS x64 (Intel) / ARM64 (Apple Silicon)
            
            **Included:**
            - Static libraries for each platform
            - C++ headers
            - C# bindings via NuGet
            - Vulkan backend with pre-compiled SPIR-V shaders
            
            Install from NuGet: `Install-Package DaktLib.GUI -Version <version>`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
